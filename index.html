<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <!-- Disable caching during development -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#00ffff">
    <meta name="description" content="Lead your syndicate in tactical cyberpunk missions. Hack, fight, and dominate the corporate world.">

    <!-- Favicon and Icons -->
    <link rel="icon" type="image/png" sizes="16x16" href="assets/logo-16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="assets/logo-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="assets/logo-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="assets/logo-180.png">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">

    <title>CyberOps: Syndicate</title>
    <link rel="stylesheet" href="cyberops-game.css">
    
    <!-- Three.js r180 Library - ES Module -->
    <script type="module" src="lib/three-loader.js"></script>
    
</head>
<body>
    <!-- Initial Start Screen -->
    <div id="initialScreen" class="initial-screen">
        <div class="initial-content">
            <div class="initial-logo">CyberOps: Syndicate</div>
            <div class="initial-subtitle">Tactical Cyberpunk Action</div>
            <div class="initial-description">
                Immerse yourself in a world of corporate espionage and tactical operations.
            </div>
            <button id="resetButton" class="reset-button">
                <span class="reset-icon">‚ö°</span>
                <span class="reset-text">START EXPERIENCE</span>
            </button>
            <div class="initial-hint">Click to begin your cyberpunk journey</div>
        </div>
        <div class="initial-bg-effects">
            <div class="bg-grid"></div>
            <div class="bg-particles"></div>
        </div>
    </div>

    <!-- Demoscene handled by screen manager (generated type) -->

    <!-- Company Logo Splash -->
    <div id="companyLogo" class="splash-screen">
        <div class="logo-container">
            <div class="company-name">NEXUS INTERACTIVE</div>
            <div class="logo-subtitle">Presents</div>
        </div>
        <!-- <div class="skip-hint">Click to skip</div> -->
    </div>

    <!-- Game Studio Splash -->
    <div id="studioLogo" class="splash-screen">
        <div class="logo-container">
            <div class="studio-name">CYBER DYNAMICS</div>
            <div class="logo-subtitle">Game Studio</div>
        </div>
        <!-- <div class="skip-hint">Click to skip</div> -->
    </div>

    <!-- Loading Screen -->
    <div id="loadingScreen" class="loading-screen">
        <div class="game-title beam-sweep">CyberOps: Syndicate</div>
        <div class="loading-bar">
            <div class="loading-progress"></div>
        </div>
        <!-- <div class="skip-hint">Click to skip</div> -->
    </div>

        <!-- Audio element for unified menu music track -->
        <!-- 3D Engine - Three.js moved to head section to load earlier -->
        

        
        
        
        
        

        <!-- Audio elements removed - using dynamic audio loading via JavaScript -->

    <!-- Main Menu handled by screen manager (DOM type) -->

    <!-- Mission Briefing handled by screen manager (DOM type) -->

    <!-- Game Canvas (2D) -->
    <canvas id="gameCanvas"></canvas>
    
    <!-- 3D Canvas Container -->
    <div id="game3DContainer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 90; display: none; pointer-events: none;">
        <!-- Three.js canvas will be inserted here -->
    </div>
    
    <!-- 3D Mode HUD -->
    <div id="game3DHUD" style="display: none;">
        <div class="crosshair">
            <div class="crosshair-dot"></div>
            <div class="crosshair-lines">
                <div class="h-line"></div>
                <div class="v-line"></div>
            </div>
        </div>
        <div class="mode-indicator" id="modeIndicator">TACTICAL</div>
        <div class="hint-text">üìç TAB to select agent | ‚å®Ô∏è E to switch camera | üéÆ WASD to move | üî´ Click to shoot</div>
        
        <!-- 3D HUD Elements -->
        <div class="hud3d-top">
            <div class="health-display-3d">HP: 100/100</div>
            <div class="ammo-display-3d">AMMO: ‚àû</div>
            <div class="objective-display-3d">Eliminate all hostiles</div>
        </div>
        
        <div class="agent-info-3d">
            <div class="agent-name-3d" id="agentName3D">Agent Selected</div>
            <div class="agent-class-3d" id="agentClass3D">Operative</div>
        </div>

        <!-- Minimap for 3D Mode -->
        <div class="minimap-3d">
            <div class="minimap-content-3d" id="minimapContent3D"></div>
        </div>

        <!-- Action Palette for 3D Mode -->
        <div class="action-bar-3d">
            <div class="action-button-3d" data-action="0">
                <span>üëÜ</span>
                <div class="action-label">Move</div>
                <div class="cooldown-overlay-3d" id="cooldown3d0"></div>
            </div>
            <div class="action-button-3d" data-action="1">
                <span>üéØ</span>
                <div class="action-label">Shoot</div>
                <div class="cooldown-overlay-3d" id="cooldown3d1"></div>
            </div>
            <div class="action-button-3d" data-action="2">
                <span>üí£</span>
                <div class="action-label">Grenade</div>
                <div class="cooldown-overlay-3d" id="cooldown3d2"></div>
            </div>
            <div class="action-button-3d" data-action="3">
                <span>üíª</span>
                <div class="action-label">Hack</div>
                <div class="cooldown-overlay-3d" id="cooldown3d3"></div>
            </div>
            <div class="action-button-3d" data-action="4">
                <span>üõ°Ô∏è</span>
                <div class="action-label">Shield</div>
                <div class="cooldown-overlay-3d" id="cooldown3d4"></div>
            </div>
        </div>

        <div class="action-hint-3d">Press R to cycle actions | Current: <span id="currentAction3D">Shoot</span></div>
    </div>

    <!-- Game HUD -->
    <div id="gameHUD">
        <div class="hud-top">
            <div class="mission-timer" id="missionTimer">00:00</div>
            <div class="objective-tracker" id="objectiveTracker">Loading...</div>
            <button class="pause-button" onclick="game.togglePause()">‚è∏</button>
        </div>

        <div class="squad-health" id="squadHealth"></div>

        <div class="minimap">
            <div class="minimap-content" id="minimapContent"></div>
        </div>

        <!-- Fog Toggle Button -->
        <div style="position: absolute; bottom: 210px; left: 20px;">
            <button class="fog-toggle-btn" onclick="game.toggleFogOfWar()" title="Toggle Fog of War (U)" style="
                background: rgba(100, 50, 150, 0.8);
                border: 2px solid #9966ff;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
                min-width: 120px;
            " id="fogBtn">
                üå´Ô∏è FOG: ON
            </button>
        </div>

        <!-- Team Commands -->
        <div class="team-commands" style="position: absolute; bottom: 150px; left: 20px; display: flex; gap: 10px;">
            <button class="team-command-btn" onclick="game.setTeamMode('hold')" title="Hold Position (H)" style="
                background: rgba(0, 100, 200, 0.8);
                border: 2px solid #00ffff;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
            " id="holdBtn">
                üö´ HOLD
            </button>
            <button class="team-command-btn" onclick="game.setTeamMode('patrol')" title="Patrol Area (P)" style="
                background: rgba(0, 150, 100, 0.8);
                border: 2px solid #00ff00;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
            " id="patrolBtn">
                üîÑ PATROL
            </button>
            <button class="team-command-btn" onclick="game.setTeamMode('follow')" title="Follow Leader (F)" style="
                background: rgba(150, 100, 0, 0.8);
                border: 2px solid #ffa500;
                color: white;
                padding: 10px 15px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
            " id="followBtn">
                üë• FOLLOW
            </button>
        </div>

        <!-- Event Log -->
        <div class="event-log" style="
            position: absolute;
            top: 100px;
            right: 20px;
            width: 450px;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #00ffff;
            border-radius: 5px;
            font-size: 12px;
            color: #fff;
            font-family: 'Courier New', monospace;
            transition: all 0.3s ease;
        " id="eventLog">
            <div style="
                padding: 5px 10px;
                background: rgba(0, 255, 255, 0.1);
                border-bottom: 1px solid #00ffff;
                display: flex;
                justify-content: space-between;
                align-items: center;
                cursor: pointer;
            " onclick="game.toggleEventLog()">
                <div style="color: #00ffff; font-weight: bold;">MISSION LOG</div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="logModeIndicator" style="color: #888; font-size: 10px;">FULL</span>
                    <span id="logToggleIcon" style="color: #00ffff;">‚ñº</span>
                </div>
            </div>

            <!-- Compact mode: shows only last event -->
            <div id="eventLogCompact" style="
                padding: 8px 10px;
                display: none;
                color: #0ff;
                font-size: 11px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            ">
                <!-- Last event will be shown here -->
            </div>

            <!-- Full log mode -->
            <div id="eventLogFull" style="
                max-height: 180px;
                overflow-y: auto;
                padding: 10px;
            ">
                <div id="eventLogContent" style="display: flex; flex-direction: column-reverse;">
                    <!-- Events will be added here -->
                </div>
            </div>
        </div>

        <div class="action-bar">
            <div class="action-button" onclick="game.useAbilityForAllSelected(0)">
                <span>üëÜ</span>
                <div class="cooldown-overlay" id="cooldown0"></div>
            </div>
            <div class="action-button" onclick="game.useAbilityForAllSelected(1)">
                <span>üéØ</span>
                <div class="cooldown-overlay" id="cooldown1"></div>
            </div>
            <div class="action-button" onclick="game.useAbilityForAllSelected(2)">
                <span>üí£</span>
                <div class="cooldown-overlay" id="cooldown2"></div>
            </div>
            <div class="action-button" onclick="game.useAbilityForAllSelected(3)">
                <span>üíª</span>
                <div class="cooldown-overlay" id="cooldown3"></div>
            </div>
            <div class="action-button" onclick="game.useAbilityForAllSelected(4)">
                <span>üõ°Ô∏è</span>
                <div class="cooldown-overlay" id="cooldown4"></div>
            </div>
        </div>
    </div>

    <!-- Victory/Defeat Screen -->
    <div id="endScreen" class="end-screen">
        <div id="endTitle" class="end-title">MISSION COMPLETE</div>
        <div class="end-stats">
            <div class="stat-row">
                <span>Time:</span>
                <span id="endTime">00:00</span>
            </div>
            <div class="stat-row">
                <span>Enemies Defeated:</span>
                <span id="endEnemies">0</span>
            </div>
            <div class="stat-row">
                <span>Objectives:</span>
                <span id="endObjectives">0/0</span>
            </div>
            <div class="stat-row">
                <span>Squad Status:</span>
                <span id="endSquad">All Alive</span>
            </div>
        </div>
        <!-- Button removed - replaced by intermission dialog -->
    </div>

    <!-- Game Complete Screen -->
    <div id="gameCompleteScreen" class="game-complete-screen">
        <div class="complete-title">üéâ MISSION ACCOMPLISHED! üéâ</div>
        <div class="complete-content">
            <div class="complete-message">
                <h2>Congratulations, Commander!</h2>
                <p>You have successfully completed all available missions in CyberOps: Syndicate.</p>
                <p>The Syndicate threat has been neutralized, and the city is safe once again.</p>
            </div>
            <div class="final-stats">
                <h3>Final Campaign Statistics:</h3>
                <div class="stat-row">
                    <span>Missions Completed:</span>
                    <span id="finalMissions">2/2</span>
                </div>
                <div class="stat-row">
                    <span>Total Time:</span>
                    <span id="finalTime">00:00</span>
                </div>
                <div class="stat-row">
                    <span>Total Enemies Neutralized:</span>
                    <span id="finalEnemies">0</span>
                </div>
            </div>
        </div>
        <div class="complete-actions">
            <button class="menu-button" onclick="game.showCredits()">CREDITS</button>
            <button class="menu-button" onclick="game.restartCampaign()">PLAY AGAIN</button>
            <button class="menu-button" onclick="game.backToMainMenu()">MAIN MENU</button>
        </div>
    </div>

    <!-- Credits Screen handled by screen manager (DOM type) -->

    <!-- Legacy HTML dialogs removed - using declarative dialog system -->

    <!-- Game Services (SOLID Architecture) -->
    <script src="js/services/logger-service.js"></script>
    <script src="js/services/formula-service.js"></script>
    <script src="js/services/resource-service.js"></script>
    <script src="js/services/agent-service.js"></script>
    <script src="js/services/mission-service.js"></script>
    <script src="js/services/mission-state-service.js"></script>
    <script src="js/services/research-service.js"></script>
    <script src="js/services/equipment-service.js"></script>
    <script src="js/services/inventory-service.js"></script>
    <script src="js/services/keybinding-service.js"></script>
    <script src="js/services/rpg-service.js"></script>
    <script src="js/services/game-state-service.js"></script>
    <script src="js/services/combat-service.js"></script>
    <script src="js/services/quest-service.js"></script>
    <script src="js/services/save-game-service.js"></script>
    <script src="js/services/game-services.js"></script>

    <!-- Flexible Engine System (interface and loader first) -->
    <script src="js/engine/campaign-interface.js"></script>
    <script src="js/engine/content-loader.js"></script>

    <!-- New Architecture: Engine and Facade separation -->
    <script src="js/engine/rendering-helpers.js"></script>
    <script src="js/engine/ui-renderer.js"></script>
    <script src="js/engine/game-engine.js"></script>
    <script src="js/engine/game-facade.js"></script>
    <script src="js/engine/game-controller.js"></script>

    <!-- Game Modules - Load in sequence to preserve functionality -->
    <script src="js/game-core.js"></script>
    <script src="js/game-equipment.js"></script>
    <script src="js/game-eventlog.js"></script>
    <script src="js/game-teamcommands.js"></script>
    <script src="js/game-keyboard.js"></script>
    <script src="js/game-turnbased.js"></script>
    <script src="js/game-turnbased-render.js"></script>
    <script src="js/game-settings.js"></script>
    <!-- Hall of Glory Screen -->
    <div id="hallOfGlory" class="hub-screen" style="display: none;">
        <div class="hall-header">
            <div class="hall-title">‚ö∞Ô∏è HALL OF GLORY</div>
            <div class="hall-subtitle">Heroes who gave everything for the cause</div>
            <button class="back-button" onclick="game.showSyndicateHub()">‚Üê Back to Hub</button>
        </div>

        <div class="hall-content">
            <div id="noFallenMessage" class="empty-message">
                <div class="empty-icon">üéñÔ∏è</div>
                <div class="empty-text">No fallen heroes yet</div>
                <div class="empty-subtext">May your agents always return home</div>
            </div>

            <div id="fallenAgentsList" class="fallen-agents-grid">
                <!-- Fallen agents will be dynamically added here -->
            </div>
        </div>

        <div class="hall-footer">
            <div class="memorial-quote">
                "They shall grow not old, as we that are left grow old;<br>
                Age shall not weary them, nor the years condemn.<br>
                At the going down of the sun and in the morning<br>
                We will remember them."
            </div>
        </div>
    </div>

    <script src="js/game-events.js"></script>
    <!-- game-maps.js removed - all maps now embedded in mission files -->
    <script src="js/game-flow.js"></script>
    <script src="js/game-saveload.js"></script>
    <script src="js/game-hub.js"></script>
    <script src="js/game-hub-dialog-generators.js"></script>
    <script src="js/modal-engine.js"></script>
    <script src="js/dialog-manager.js"></script>
    <script src="js/declarative-dialog-engine.js"></script>
    <script src="js/dialog-config.js"></script>
    <script src="js/dialog-config-modals.js"></script>
    <script src="js/dialog-config-screens.js"></script>
    <script src="js/dialog-integration.js"></script>
    <script src="js/dialog-integration-modals.js"></script>
    <script src="js/dialog-integration-screens.js"></script>
    <script src="js/dialog-integration-additional.js"></script>

    <!-- Screen Manager System (for full-screen states) -->
    <script src="js/screen-manager.js"></script>
    <script src="js/screen-config.js?v=2.0"></script>

    <script src="js/game-dialogs.js"></script>
    <script src="js/game-npc.js"></script>
    <script src="js/game-screens.js"></script>
    <script src="js/game-demoscene.js"></script>
    <script src="js/game-audio.js"></script>
    <script src="js/game-audioloader.js"></script>
    <script src="js/game-music-config.js"></script>
    <script src="js/game-music-system.js"></script>
    <script src="js/game-screen-music.js"></script>

    <!-- RPG System -->
    <script src="js/game-rpg-system.js"></script>
    <script src="js/game-rpg-integration.js"></script>
    <script src="js/game-rpg-ui.js"></script>
    <script src="js/game-effects-config.js"></script>
    <script src="js/game-visual-effects.js"></script>

    <!-- Engine Integration (must load after CyberOpsGame is defined) -->
    <script src="js/engine/engine-integration.js"></script>
    <!-- game-loop.js removed - functionality moved to GameEngine/GameFacade/Services -->
    <script src="js/game-pathfinding.js"></script>
    <!-- game-rendering.js removed - functionality moved to GameEngine/RenderingHelpers -->
    <script src="js/game-3d.js"></script>
    <script src="js/game-utils.js"></script>

    <!-- Mission System -->
    <script src="js/campaign-system.js"></script>
    <!-- game-maps-data.js removed - maps now embedded in mission files -->
    <script src="js/game-mission-constants.js"></script>
    <script src="js/game-mission-executor.js"></script>
    <script src="js/game-mission-integration.js"></script>
    <script src="js/campaign-integration.js"></script>

    <!-- Campaign Configuration -->
    <script src="campaigns/main/campaign-content.js"></script>
    <script src="campaigns/main/campaign-config.js"></script>
    <script src="campaigns/main/npcs.js"></script>

    <script src="js/game-init.js"></script>

    <!-- Service Worker DISABLED - Causes caching issues during development -->
    <script>
        // DISABLED: Service worker causes caching confusion during development
        // To re-enable, uncomment the registration code below

        // First, unregister any existing service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.getRegistrations().then(function(registrations) {
                for(let registration of registrations) {
                    registration.unregister().then(function(success) {
                        if (success) {
                            console.log('üóëÔ∏è Service Worker unregistered successfully');
                        }
                    });
                }
            });

            // Clear all caches
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                        console.log('üóëÔ∏è Cache cleared:', name);
                    }
                });
            }
        }

        /* DISABLED SERVICE WORKER REGISTRATION
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('‚úÖ Service Worker registered:', registration);

                        // Check for updates periodically
                        setInterval(() => {
                            registration.update();
                        }, 60000); // Check every minute

                        // Handle updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;

                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('üîÑ New version available! Refresh to update.');

                                    // Show update notification to user
                                    if (window.game && window.game.showNotification) {
                                        window.game.showNotification('New version available! Refresh to update.', 'info');
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('‚ùå Service Worker registration failed:', error);
                    });
            });
        }
        */

        // PWA Install prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            // Prevent Chrome 67 and earlier from automatically showing the prompt
            e.preventDefault();
            // Stash the event so it can be triggered later
            deferredPrompt = e;

            // Show install button if game has UI for it
            if (window.game && window.game.showInstallButton) {
                window.game.showInstallButton();
            }
        });

        // Handle install button click
        window.installPWA = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to install prompt: ${outcome}`);
                deferredPrompt = null;
            }
        };

        // Detect if app was installed
        window.addEventListener('appinstalled', () => {
            console.log('‚úÖ PWA was installed');
            deferredPrompt = null;
        });
    </script>
</body>
</html>