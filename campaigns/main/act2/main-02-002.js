// Mission: Final Convergence
// Campaign: Main Campaign
// Act: 2 - Escalation
// Mission: 002

(function() {
    const mission = {
        id: 'main-02-002',
        campaign: 'main',
        act: 2,
        missionNumber: 2,

        name: 'Final Convergence',
        title: 'Research Lab Assault',
        description: 'Assault Nexus Corp\'s fortified research lab and destroy Project Convergence.',
        briefing: 'This is it. Everything we\'ve done has led to this moment. Nexus Corp\'s main research facility houses Project Convergence - an AI weapons system designed to create autonomous killing machines. Our recon shows they\'re days away from activation. We\'ve crippled their manufacturing, exposed their government allies, and eliminated their criminal network. Now we end this. Breach the outer defenses, fight through their security forces, and capture the mainframe. Once we have control, we can shut down Convergence permanently. The fate of millions depends on what happens in the next hour. Good luck, operatives.',
        storyContext: 'The final battle. Stop Project Convergence and end Nexus Corp\'s threat once and for all.',
        region: 'asia',
        location: 'Singapore',

        agents: {
            max: 8,
            required: 3,
            recommended: 6
        },

        map: {
            type: 'fortress',
            name: 'Fortified Research Lab',
            width: 100,
            height: 100,
            spawn: { x: 50, y: 95 },
            extraction: { x: 50, y: 5 },

            generation: {
                baseType: 'walls',

                outerWalls: { x1: 10, y1: 10, x2: 89, y2: 89 },
                middleWalls: { x1: 25, y1: 25, x2: 74, y2: 74 },
                innerWalls: { x1: 40, y1: 40, x2: 59, y2: 59 },

                gates: [
                    { x: 50, y: 10, type: 'outer' },
                    { x: 50, y: 25, type: 'middle' },
                    { x: 50, y: 40, type: 'inner' }
                ],

                towers: [
                    { x: 20, y: 20 }, { x: 80, y: 20 },
                    { x: 20, y: 80 }, { x: 80, y: 80 }
                ],

                mainframe: { x: 48, y: 48, width: 4, height: 4 }
            },

            embedded: {
                tiles: [
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "....................................................................................................",
                    "...................................................................................................."
                ], 
                spawn: { x: 50, y: 95 },
                extraction: { x: 50, y: 5 },
                items: [
                    { type: 'gate', x: 50, y: 10, id: 0 },
                    { type: 'gate', x: 50, y: 25, id: 1 },
                    { type: 'gate', x: 50, y: 40, id: 2 },
                    { type: 'terminal', x: 50, y: 50, id: 'mainframe', name: 'Central Mainframe', sprite: 'üñ•Ô∏è' }
                ],
                doors: [],
                coverCount: 120
            },

            gates: [
                { x: 50, y: 10, breached: false, id: 0 },
                { x: 50, y: 25, breached: false, id: 1 },
                { x: 50, y: 40, breached: false, id: 2 }
            ],

            terminals: [
                { x: 50, y: 50, hacked: false, id: 'mainframe' }
            ],

            enemySpawns: [
                { x: 30, y: 30 }, { x: 70, y: 30 },
                { x: 30, y: 70 }, { x: 70, y: 70 },
                { x: 50, y: 20 }, { x: 50, y: 80 },
                { x: 20, y: 50 }, { x: 80, y: 50 },
                { x: 45, y: 45 }, { x: 55, y: 55 },
                { x: 45, y: 55 }, { x: 55, y: 45 }
            ],

            coverPositions: 120
        },

        objectives: [
            {
                id: 'breach_outer',
                type: 'interact',
                target: 'gate',
                specific: [0],
                count: 1,
                required: true,
                description: 'Breach outer gate',
                displayText: 'Outer gate breached: {current}/{required}'
            },
            {
                id: 'breach_inner',
                type: 'interact',
                target: 'gate',
                specific: [1, 2],
                count: 2,
                required: true,
                description: 'Breach inner defenses',
                displayText: 'Inner defenses breached: {current}/{required}',
                triggerAfter: ['breach_outer']
            },
            {
                id: 'capture_mainframe',
                type: 'interact',
                target: 'terminal',
                specific: ['mainframe'],
                count: 1,
                required: true,
                description: 'Capture the mainframe',
                displayText: 'Mainframe captured: {current}/{required}',
                triggerAfter: ['breach_inner']
            },
            {
                id: 'avoid_civilians',
                type: 'custom',
                required: false,
                description: 'No civilian casualties',
                displayText: 'Clean operation: No civilian casualties',
                checkFunction: 'checkNoCivilianCasualties',
                rewards: { credits: 500, researchPoints: 20 }
            },
            {
                id: 'keep_agents_alive',
                type: 'custom',
                required: false,
                description: 'Keep all agents alive',
                displayText: 'Perfect extraction: All agents alive',
                checkFunction: 'checkAgentsAlive',
                minAgents: 4,
                rewards: { credits: 1000, researchPoints: 50 }
            }
        ],

        enemies: {
            count: 12,
            types: ['guard', 'soldier', 'heavy', 'sniper'],
            waves: [
                { trigger: 'breach_outer', count: 8, delay: 5 },
                { trigger: 'breach_inner', count: 10, delay: 10 }
            ]
        },

        rewards: {
            credits: 5000,
            researchPoints: 150,
            worldControl: 10
        },

        // Victory/Ending content for campaign finale
        victory: {
            title: 'PROJECT CONVERGENCE DESTROYED',
            message: 'You did it. The mainframe is ours, and Project Convergence has been permanently shut down. Nexus Corp\'s dream of autonomous weapons dies today.',
            epilogue: [
                'With the AI weapons system destroyed and their research erased, Nexus Corporation faces international investigation.',
                'The evidence you gathered throughout the campaign has been leaked to every major news outlet.',
                'Government officials who funded Project Convergence are being arrested as we speak.',
                'The criminal syndicates that served as Nexus\'s muscle have scattered without their corporate backing.',
                'The Syndicate remains in the shadows, watching. There will always be another corporation, another threat.',
                'But today, you saved countless lives. Rest well, operatives. You\'ve earned it.'
            ],
            creditsRoll: true,
            unlocks: ['new_game_plus', 'hard_mode']
        },

        // Defeat text
        defeat: {
            title: 'MISSION FAILED',
            message: 'Project Convergence goes online. Autonomous weapons flood the streets. The world will never be the same.',
            retryPrompt: 'The Syndicate doesn\'t give up. Try again?'
        },

        // Flag this as the campaign finale
        isCampaignFinale: true,

        // NPCs
        npcs: [
            {
                id: 'dr_chen_finale',
                spawn: { x: 45, y: 85 },  // Near spawn, joins the assault
                quests: ['shutdown_sequence']
            },
            {
                id: 'facility_insider',
                spawn: { x: 55, y: 75 },  // Outer perimeter
                quests: ['gate_codes']
            },
            {
                id: 'resistance_leader',
                spawn: { x: 30, y: 70 },  // Coordinating from west
                quests: ['coordinated_assault']
            },
            {
                id: 'freed_prisoner',
                spawn: { x: 50, y: 55 },  // Inside, after gates breached
                quests: ['save_subjects']
            }
        ]
    };

    if (typeof CampaignSystem !== 'undefined') {
        CampaignSystem.registerMission('main', 2, 'main-02-002', mission);
    }
    if (typeof window !== 'undefined') {
        window.CAMPAIGN_MISSIONS = window.CAMPAIGN_MISSIONS || {};
        window.CAMPAIGN_MISSIONS['main-02-002'] = mission;
    }
})();