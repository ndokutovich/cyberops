@startuml CyberOps_Game_Architecture

!define ABSTRACT abstract
!define SERVICE #LightBlue
!define GAME #LightGreen
!define ENGINE #LightYellow
!define DIALOG #Pink
!define MANAGER #Orange
!define INTEGRATION #LightGray

' =====================================
' Core Game Class
' =====================================
class CyberOpsGame GAME {
    ' Core Properties (via getters/setters)
    + credits : number
    + researchPoints : number
    + worldControl : number
    + weapons : array
    + equipment : array
    + activeAgents : array
    + availableAgents : array
    + agentLoadouts : object

    ' UI State Properties
    + currentScreen : string
    + currentMission : object
    + isPaused : boolean
    + selectedAgent : object
    + currentInventoryMode : string
    + currentInventoryTab : string

    ' Game State
    + completedMissions : array
    + missionCount : number
    + missionTrackers : object
    + extractionEnabled : boolean

    ' Systems References
    + gameServices : GameServices
    + dialogEngine : DeclarativeDialogEngine
    + rpgManager : RPGManager
    + inventoryManager : InventoryManager
    + shopManager : ShopManager

    ' Core Methods
    + constructor()
    + init()
    + startNewCampaign()
    + loadMission()
    + update()
    + render()
}

' =====================================
' Service Layer
' =====================================
class GameServices SERVICE {
    ' Core Services (no dependencies)
    + formulaService : FormulaService
    + resourceService : ResourceService
    + agentService : AgentService

    ' Mission Services
    + missionService : MissionService
    + missionStateService : MissionStateService
    + questService : QuestService

    ' Inventory & Equipment Services
    + inventoryService : InventoryService
    + equipmentService : EquipmentService
    + catalogService : CatalogService
    + itemService : ItemService

    ' RPG & Research Services
    + rpgService : RPGService
    + researchService : ResearchService

    ' Combat & Enemy Services
    + combatService : CombatService
    + enemyService : EnemyService

    ' State & Save Services
    + gameStateService : GameStateService
    + saveGameService : SaveGameService

    ' Input & Settings Services
    + keybindingService : KeybindingService
    + keyboardDispatcher : KeyboardDispatcherService
    + settingsService : SettingsService

    ' UI & Audio Services
    + hudService : HUDService
    + audioService : AudioService
    + dialogStateService : DialogStateService

    ' Utility Services
    + coordinateService : CoordinateService
    + pathfindingService : PathfindingService

    + constructor()
    + initialize()
    + initializeHUD(game)
    + calculateAgentStats()
    + calculateAttackDamage()
}

class FormulaService SERVICE {
    - formulas : Map
    - combatConfig : object
    - logger : Logger

    + calculateDamage(baseDamage, weaponDamage, bonuses, armor)
    + calculateHitChance(attacker, target, distance)
    + calculateCritical(attacker)
    + calculateDodge(target)
    + calculateHealing(baseHeal, bonuses)
    + setFormulas(formulas)
    + setCombatConfig(config)
}

class ResourceService SERVICE {
    - resources : object
    - limits : object
    - history : array
    - listeners : Map
    - logger : Logger

    + get(resourceType) : number
    + set(resourceType, value, reason)
    + add(resourceType, amount, reason)
    + spend(resourceType, amount, reason)
    + earn(resourceType, amount, reason)
    + canAfford(resourceType, amount) : boolean
    + getCredits() : number
    + setCredits(value)
    + getResearchPoints() : number
    + setResearchPoints(value)
    + getWorldControl() : number
    + exportState() : object
    + importState(state)
}

class AgentService SERVICE {
    - availableAgents : array
    - activeAgents : array
    - fallenAgents : array
    - maxActiveAgents : number
    - listeners : Map
    - logger : Logger

    + initialize(agents)
    + getActiveAgents() : array
    + getAvailableAgents() : array
    + getFallenAgents() : array
    + clearAllAgents()
    + addAvailableAgent(agent)
    + hireAgent(agentId) : boolean
    + fireAgent(agentId) : boolean
    + healAgent(agentId, amount) : boolean
    + damageAgent(agentId, amount, source) : boolean
    + killAgent(agentId, killer) : boolean
    + reviveAgent(agentId, cost) : boolean
    + findAgent(agentId) : object
    + exportState() : object
    + importState(state)
}

class InventoryService SERVICE {
    - inventory : object
    - agentLoadouts : object
    - formulaService : FormulaService
    - equipmentService : EquipmentService
    - logger : Logger

    + initialize(data)
    + getWeapons() : array
    + getEquipment() : array
    + getAgentLoadout(agentId) : object
    + getAllLoadouts() : object
    + getItemById(type, itemId) : object
    + setAgentLoadout(agentId, loadout)
    + equipItem(agentId, slot, itemId) : boolean
    + unequipItem(agentId, slot) : boolean
    + pickupItem(item) : boolean
    + buyItem(itemType, itemId) : object
    + sellItem(itemType, itemId, quantity) : object
    + hasItem(itemType, itemId) : boolean
    + exportState() : object
    + importState(state)
}

class EquipmentService SERVICE {
    - formulaService : FormulaService
    - logger : Logger

    + optimizeLoadouts(agents, weapons, equipment) : object
    + calculateLoadoutScore(agent, loadout) : number
    + applyLoadoutToAgent(agent, loadout)
    + getAvailableItems(weapons, equipment) : object
    + isItemEquipped(item) : boolean
    + canEquipItem(agent, item) : boolean
}

class RPGService SERVICE {
    - formulaService : FormulaService
    - rpgManager : RPGManager
    - inventoryManager : InventoryManager
    - shopManager : ShopManager
    - rpgConfig : object
    - logger : Logger

    + initialize()
    + calculateRPGDamage(attacker, target, weaponType) : number
    + grantExperience(entity, amount)
    + syncEquipment()
    + syncLoadouts()
    + createRPGAgent(agent, className) : object
    + createRPGEnemy(enemy, enemyType) : object
    + loadRPGConfig()
    + getRPGConfig() : object
    + setConfig(config)
}

class ResearchService SERVICE {
    - researchTree : object
    - completedResearch : array
    - activeResearch : object
    - formulaService : FormulaService
    - logger : Logger

    + loadTree(tree)
    + canResearch(techId) : boolean
    + startResearch(techId) : boolean
    + completeResearch(techId) : boolean
    + isResearched(techId) : boolean
    + getAvailableResearch() : array
    + getResearchProgress(techId) : number
    + exportState() : object
    + importState(state)
}

class MissionService SERVICE {
    - currentMission : object
    - missionTrackers : object
    - extractionEnabled : boolean
    - objectives : array
    - validators : Map
    - listeners : Map
    - logger : Logger

    + startMission(missionDef)
    + updateObjective(event, data)
    + checkObjectiveCompletion() : boolean
    + enableExtraction()
    + completeMission(success)
    + trackEvent(eventName, data)
    + getMissionProgress() : object
    + registerValidator(name, func)
    + completeObjective(objectiveId)
    + exportState() : object
    + importState(state)
}

class MissionStateService SERVICE {
    - preAssaultState : object
    - missionInProgress : boolean
    - logger : Logger

    + capturePreAssaultState(game)
    + restorePreAssaultState(game)
    + isMissionInProgress() : boolean
    + clearMissionState()
}

class QuestService SERVICE {
    - activeQuests : Map
    - completedQuests : array
    - resourceService : ResourceService
    - logger : Logger

    + startQuest(quest)
    + updateQuest(questId, event)
    + completeQuest(questId) : object
    + getActiveQuests() : array
    + isQuestComplete(questId) : boolean
    + getQuestProgress(questId) : object
}

class CatalogService SERVICE {
    - weaponCatalog : Map
    - armorCatalog : Map
    - utilityCatalog : Map
    - consumableCatalog : Map
    - logger : Logger

    + initialize(rpgConfig)
    + getItemsByCategory(category) : array
    + getItemById(category, itemId) : object
    + getPlayerStartingInventory() : object
    + getAllItems() : object
}

class ItemService SERVICE {
    - resourceService : ResourceService
    - formulaService : FormulaService
    - inventoryService : InventoryService
    - logger : Logger

    + processCollectable(collectable, agent) : object
    + applyItemEffect(item, agent)
    + getItemValue(item) : number
}

class CombatService SERVICE {
    - formulaService : FormulaService
    - agentService : AgentService
    - projectiles : array
    - combatLog : array
    - logger : Logger

    + performAttack(attackerId, targetId, weaponType) : object
    + calculateHitChance(attacker, target) : number
    + processDamage(target, damage, source) : object
    + addProjectile(projectile)
    + updateProjectiles(deltaTime)
    + getCombatLog() : array
}

class EnemyService SERVICE {
    - enemies : array
    - enemyTypes : Map
    - spawnPoints : array
    - logger : Logger

    + initialize(missionDef)
    + spawnEnemy(type, position) : object
    + removeEnemy(enemyId)
    + getEnemies() : array
    + getEnemyById(id) : object
    + updateEnemyAI(deltaTime)
    + clearEnemies()
}

class NPCService SERVICE {
    - npcs : array
    - quests : object
    - npcInteractions : Set
    - npcInteractionRange : number
    - questService : QuestService
    - gameContext : CyberOpsGame
    - logger : Logger

    + initialize(gameContext)
    + clearNPCs()
    + getNPCs() : array
    + getNPC(npcId) : object
    + findValidSpawnPosition(x, y) : object
    + spawnNPCs(missionDef, missionIndex) : array
    + getNPCsForMission(missionDef) : array
    + createNPCFromDefinition(npcDef) : object
    + getNearbyNPC(agent) : object
    + updateNPCs()
    + saveState() : object
    + loadState(state)
}

class SaveGameService SERVICE {
    - gameStateService : GameStateService
    - saveSlots : array
    - autoSaveEnabled : boolean
    - logger : Logger

    + saveGame(slot, name) : boolean
    + loadGame(slot) : boolean
    + getSaveSlots() : array
    + deleteSave(slot)
    + exportSave(slot) : string
    + importSave(data) : boolean
    + autoSave()
}

class PathfindingService SERVICE {
    - grid : array
    - openSet : array
    - closedSet : Set
    - logger : Logger

    + initialize(map)
    + findPath(start, end) : array
    + isWalkable(x, y) : boolean
    + getNeighbors(node) : array
    + heuristic(a, b) : number
    + setObstacle(x, y, blocked)
}

class KeyboardDispatcherService SERVICE {
    - handlers : Map
    - activeContext : string
    - eventListener : function
    - logger : Logger

    + initialize()
    + registerHandler(context, key, handler)
    + unregisterHandler(context, key)
    + setActiveContext(context)
    + handleKeyEvent(event)
    + getActiveContext() : string
}

class SettingsService SERVICE {
    - settings : object
    - defaults : object
    - listeners : Map
    - logger : Logger

    + initialize()
    + get(key) : any
    + set(key, value)
    + reset(key)
    + resetAll()
    + exportSettings() : object
    + importSettings(settings)
    + subscribe(key, callback)
}

class HUDService SERVICE {
    - game : CyberOpsGame
    - elements : Map
    - updateQueue : array
    - logger : Logger

    + registerAllElements()
    + registerElement(id, updateFn)
    + update(elementId)
    + updateAll()
    + show(elementId)
    + hide(elementId)
    + setVisibility(elementId, visible)
}

class AudioService SERVICE {
    - audioContext : AudioContext
    - tracks : Map
    - sfxPool : Map
    - masterVolume : number
    - musicVolume : number
    - sfxVolume : number
    - currentTrack : object
    - logger : Logger

    + initialize()
    + playMusic(trackId, options)
    + stopMusic(fadeOut)
    + playSFX(sfxId, options)
    + setMasterVolume(volume)
    + setMusicVolume(volume)
    + setSFXVolume(volume)
    + crossfade(fromTrack, toTrack, duration)
}

class DialogStateService SERVICE {
    - currentState : string
    - stateStack : array
    - dialogEngine : DeclarativeDialogEngine
    - logger : Logger

    + navigateTo(stateId, context)
    + back()
    + close()
    + getCurrentState() : string
    + getStateStack() : array
    + canNavigateTo(stateId) : boolean
}

class CoordinateService SERVICE {
    - tileWidth : number
    - tileHeight : number
    - cameraX : number
    - cameraY : number
    - zoom : number
    - logger : Logger

    + initialize(config)
    + worldToIsometric(x, y) : object
    + isometricToWorld(isoX, isoY) : object
    + screenToWorld(screenX, screenY) : object
    + worldToScreen(worldX, worldY) : object
    + setCamera(x, y)
    + setZoom(zoom)
}

class GameStateService SERVICE {
    - resourceService : ResourceService
    - agentService : AgentService
    - inventoryService : InventoryService
    - missionService : MissionService
    - saveSlots : number
    - currentSlot : number
    - saveVersion : string
    - autoSaveEnabled : boolean
    - logger : Logger

    + initialize()
    + collectGameState(game) : object
    + applyGameState(game, state) : boolean
    + saveGame(game, slot, isAutoSave) : boolean
    + loadGame(game, slot) : boolean
    + quickSave(game) : boolean
    + quickLoad(game) : boolean
    + getSaveSlots() : array
    + deleteSave(slot)
    + exportSave(slot) : string
    + importSave(file, slot) : boolean
}

' =====================================
' Dialog System
' =====================================
class DeclarativeDialogEngine DIALOG {
    - config : object
    - currentState : string
    - stateStack : array
    - stateData : object
    - generators : Map
    - actions : Map
    - transitions : Map

    + navigateTo(stateId, context, forceRefresh)
    + back()
    + close()
    + closeAll()
    + registerGenerator(name, func)
    + registerAction(name, func)
    + canTransition(from, to) : boolean
    + executeAction(action, context)
}

class DialogIntegration INTEGRATION {
    + generateEquipmentManagement() : string
    + generateAgentManagement() : string
    + generateArsenalContent() : string
    + generateCharacterSheet() : string
    + generateResearchLab() : string
    + handleEquipmentAction(action, params)
    + handleAgentAction(action, params)
}

class ModalEngine DIALOG {
    - modals : array
    - baseZIndex : number

    + createModal(options) : Modal
    + showConfirmation(title, message, onConfirm, onCancel)
    + showAlert(title, message, onOk)
    + closeAll()
}

' =====================================
' RPG System
' =====================================
class RPGManager MANAGER {
    - config : object
    - entities : Map
    - experienceTable : array
    - levelUpCallbacks : array
    - logger : Logger

    + createRPGAgent(agent, className) : RPGEntity
    + createRPGEnemy(enemy, type) : RPGEntity
    + calculateDerivedStats(entity) : object
    + levelUp(entity)
    + grantExperience(entity, xp)
    + loadConfig(config)
    + generateExperienceTable()
    + onLevelUp(callback)
    + getExperienceForLevel(level) : number
}

class InventoryManager MANAGER {
    - inventories : Map

    + createInventory(entityId, maxWeight) : Inventory
    + getInventory(entityId) : Inventory
    + transferItem(fromId, toId, itemId) : boolean
    + dropItem(entityId, itemId) : boolean
}

class ShopManager MANAGER {
    - shops : Map
    - rpgManager : RPGManager
    - inventoryManager : InventoryManager
    - rpgConfig : object

    + constructor(rpgManager, inventoryManager)
    + setConfig(config)
    + loadShops()
    + generateShopInventory(shop) : array
    + buyItem(shopId, itemId, quantity, buyerId) : boolean
    + sellItem(shopId, itemId, quantity, sellerId) : boolean
    + getShopInventory(shopId) : array
}

' =====================================
' Engine Layer
' =====================================
class ContentLoader ENGINE {
    - currentCampaign : object
    - contentCache : Map
    - formulas : Map
    - strings : object

    + loadCampaign(campaign, game) : boolean
    + loadRPGConfig(game)
    + loadAgents(game)
    + loadEquipment(game)
    + loadEnemies(game)
    + loadEconomy(game)
    + loadCombatFormulas(game)
    + loadUIStrings(game)
    + getString(key, params) : string
    + getContent(type) : object
}

class CampaignInterface ENGINE {
    <<interface>>
    + validateCampaign(campaign) : object
    + validateMission(mission) : object
    + validateAgent(agent) : object
    + validateWeapon(weapon) : object
    + mergeCampaignWithDefaults(campaign) : object
}

class CampaignSystem ENGINE {
    - campaigns : Map
    - missions : Map

    + registerCampaign(id, data)
    + registerMission(campaignId, actId, missionId, data)
    + getCampaign(id) : object
    + getMission(campaignId, missionId) : object
    + getAllMissions(campaignId) : array
}

' =====================================
' Utility Services
' =====================================
class Logger {
    - source : string
    - minLevel : LogLevel
    <<static>> - history : array

    + trace(message, ...args)
    + debug(message, ...args)
    + info(message, ...args)
    + warn(message, ...args)
    + error(message, ...args)
    + fatal(message, ...args)
    <<static>> + getHistory(filters) : array
    <<static>> + setMinLevel(source, level)
}

class KeybindingService SERVICE {
    - bindings : Map
    - handlers : Map

    + registerBinding(key, action)
    + registerHandler(action, handler)
    + handleKeyPress(event)
    + getBindings() : object
    + setBinding(action, key)
}

' =====================================
' Relationships
' =====================================

' Game to Services
CyberOpsGame --> GameServices : uses
CyberOpsGame --> DeclarativeDialogEngine : uses

' GameServices composition - Core Services
GameServices *-- FormulaService : owns
GameServices *-- ResourceService : owns
GameServices *-- AgentService : owns

' GameServices composition - Mission Services
GameServices *-- MissionService : owns
GameServices *-- MissionStateService : owns
GameServices *-- QuestService : owns
GameServices *-- NPCService : owns

' GameServices composition - Inventory & Equipment
GameServices *-- InventoryService : owns
GameServices *-- EquipmentService : owns
GameServices *-- CatalogService : owns
GameServices *-- ItemService : owns

' GameServices composition - RPG & Research
GameServices *-- RPGService : owns
GameServices *-- ResearchService : owns

' GameServices composition - Combat & Enemy
GameServices *-- CombatService : owns
GameServices *-- EnemyService : owns

' GameServices composition - State & Save
GameServices *-- GameStateService : owns
GameServices *-- SaveGameService : owns

' GameServices composition - Input & Settings
GameServices *-- KeybindingService : owns
GameServices *-- KeyboardDispatcherService : owns
GameServices *-- SettingsService : owns

' GameServices composition - UI & Audio
GameServices *-- HUDService : owns
GameServices *-- AudioService : owns
GameServices *-- DialogStateService : owns

' GameServices composition - Utility
GameServices *-- CoordinateService : owns
GameServices *-- PathfindingService : owns

' Service dependencies - Inventory & Equipment
InventoryService --> FormulaService : uses
InventoryService --> EquipmentService : uses
EquipmentService --> FormulaService : uses
ItemService --> ResourceService : uses
ItemService --> FormulaService : uses
ItemService --> InventoryService : uses

' Service dependencies - RPG & Research
RPGService --> FormulaService : uses
RPGService --> ResourceService : uses
ResearchService --> FormulaService : uses

' Service dependencies - State & Save
GameStateService --> ResourceService : uses
GameStateService --> AgentService : uses
GameStateService --> InventoryService : uses
GameStateService --> MissionService : uses
SaveGameService --> GameStateService : uses

' Service dependencies - Mission & Quest
MissionService --> ResourceService : uses
MissionService --> AgentService : uses
QuestService --> ResourceService : uses
NPCService --> QuestService : uses

' Service dependencies - Combat
CombatService --> FormulaService : uses
CombatService --> AgentService : uses

' Service dependencies - Audio
AudioService --> KeyboardDispatcherService : uses

' Service dependencies - Dialog
DialogStateService --> DeclarativeDialogEngine : uses

' RPG System (owned by RPGService)
RPGService *-- RPGManager : owns
RPGService *-- InventoryManager : owns
RPGService *-- ShopManager : owns

' ShopManager dependencies
ShopManager --> RPGManager : uses
ShopManager --> InventoryManager : uses

' Dialog System
DeclarativeDialogEngine --> DialogIntegration : uses
CyberOpsGame --> ModalEngine : uses

' Content Loading
ContentLoader --> CampaignInterface : uses
ContentLoader --> GameServices : configures
CyberOpsGame --> ContentLoader : uses
CyberOpsGame --> CampaignSystem : uses

' All services use Logger
FormulaService --> Logger : uses
ResourceService --> Logger : uses
AgentService --> Logger : uses
InventoryService --> Logger : uses
EquipmentService --> Logger : uses
RPGService --> Logger : uses
ResearchService --> Logger : uses
MissionService --> Logger : uses
GameStateService --> Logger : uses
MissionStateService --> Logger : uses
QuestService --> Logger : uses
CatalogService --> Logger : uses
ItemService --> Logger : uses
CombatService --> Logger : uses
EnemyService --> Logger : uses
NPCService --> Logger : uses
SaveGameService --> Logger : uses
PathfindingService --> Logger : uses
KeyboardDispatcherService --> Logger : uses
SettingsService --> Logger : uses
HUDService --> Logger : uses
AudioService --> Logger : uses
DialogStateService --> Logger : uses
CoordinateService --> Logger : uses

@enduml