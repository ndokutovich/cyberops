<!DOCTYPE html>
<html>
<head>
    <title>Turn-Based Mode Test</title>
    <style>
        body {
            font-family: monospace;
            background: #000;
            color: #0f0;
            padding: 20px;
        }
        .test-section {
            border: 1px solid #0f0;
            padding: 10px;
            margin: 10px 0;
        }
        .pass { color: #0f0; }
        .fail { color: #f00; }
        .pending { color: #ff0; }
        button {
            background: #111;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px 10px;
            margin: 5px;
            cursor: pointer;
        }
        button:hover {
            background: #0f0;
            color: #000;
        }
    </style>
</head>
<body>
    <h1>Turn-Based Mode Test Suite</h1>

    <div class="test-section">
        <h2>Initialization Tests</h2>
        <div id="init-tests"></div>
        <button onclick="testInit()">Run Init Tests</button>
    </div>

    <div class="test-section">
        <h2>Turn-Based Toggle Test</h2>
        <div id="toggle-test"></div>
        <button onclick="testToggle()">Test Space Key Toggle</button>
    </div>

    <div class="test-section">
        <h2>AP System Test</h2>
        <div id="ap-test"></div>
        <button onclick="testAP()">Test Action Points</button>
    </div>

    <div class="test-section">
        <h2>Grid Snap Test</h2>
        <div id="grid-test"></div>
        <button onclick="testGrid()">Test Grid Snap (B key)</button>
    </div>

    <div class="test-section">
        <h2>Manual Test Instructions - Two-Click Movement System</h2>
        <ol>
            <li>Open the game: <a href="cyberops-game.html" target="_blank">cyberops-game.html</a></li>
            <li>Start a mission (any act)</li>
            <li>Press <strong>Space</strong> - Toggle turn-based mode ON</li>
            <li>Look for "Turn-based mode: ON" notification</li>
            <li><strong>First Click</strong> on a destination:
                <ul>
                    <li>Should show path preview with dotted line</li>
                    <li>Path should be color-coded (green=this turn, yellow=next turn, etc)</li>
                    <li>Should show destination marker (pulsing white circle)</li>
                    <li>Should show "CLICK TO MOVE" text above marker</li>
                    <li>If multi-turn, should show turn count near marker</li>
                </ul>
            </li>
            <li><strong>Click on marker</strong> to confirm:
                <ul>
                    <li>Agent should animate smoothly along path</li>
                    <li>Movement speed should respect game speed (Z key)</li>
                    <li>AP should be deducted after movement</li>
                </ul>
            </li>
            <li><strong>Click elsewhere</strong> to cancel and rebuild path</li>
            <li>Press <strong>Y</strong> - End turn, next unit auto-selected</li>
            <li>Press <strong>B</strong> - Toggle grid snap on/off</li>
            <li>Press <strong>Z</strong> - Change game speed (1x/2x/4x)</li>
            <li>Press <strong>Space</strong> again - Exit turn-based mode</li>
        </ol>
        <div class="pass">✓ Two-click movement system implemented</div>
        <div class="pass">✓ Multi-turn path visualization with colors</div>
        <div class="pass">✓ Animated movement respects game speed</div>
        <div class="pass">✓ Destination marker with pulsing effect</div>
    </div>

    <script>
        // Create a mock game object for testing
        const mockGame = {
            agents: [
                {name: 'Agent 1', x: 100, y: 100, alive: true, speed: 2},
                {name: 'Agent 2', x: 200, y: 200, alive: true, speed: 2}
            ],
            enemies: [
                {x: 300, y: 300, alive: true, type: 'guard'}
            ],
            tileWidth: 64,
            tileHeight: 32,
            currentScreen: 'game',
            addNotification: (msg) => console.log('Notification:', msg)
        };

        function testInit() {
            const results = document.getElementById('init-tests');
            results.innerHTML = '';

            // Load the turn-based module
            const script = document.createElement('script');
            script.src = 'js/game-turnbased.js';
            script.onload = () => {
                // Test initialization
                try {
                    mockGame.initTurnBasedMode = CyberOpsGame.prototype.initTurnBasedMode;
                    mockGame.initTurnBasedMode();

                    // Check all required properties
                    const checks = [
                        {name: 'turnBasedMode initialized', test: mockGame.turnBasedMode === false},
                        {name: 'gridSnapMovement initialized', test: mockGame.gridSnapMovement === true},
                        {name: 'apConfig exists', test: mockGame.apConfig !== undefined},
                        {name: 'actionCosts exists', test: mockGame.actionCosts !== undefined},
                        {name: 'turnQueue initialized', test: Array.isArray(mockGame.turnQueue)},
                        {name: 'movementPreviewTiles initialized', test: Array.isArray(mockGame.movementPreviewTiles)}
                    ];

                    checks.forEach(check => {
                        const div = document.createElement('div');
                        div.className = check.test ? 'pass' : 'fail';
                        div.textContent = `${check.test ? '✓' : '✗'} ${check.name}`;
                        results.appendChild(div);
                    });
                } catch (e) {
                    results.innerHTML = `<div class="fail">Error: ${e.message}</div>`;
                }
            };
            document.head.appendChild(script);
        }

        function testToggle() {
            const results = document.getElementById('toggle-test');
            try {
                mockGame.toggleTurnBasedMode = CyberOpsGame.prototype.toggleTurnBasedMode;
                mockGame.enterTurnBasedMode = CyberOpsGame.prototype.enterTurnBasedMode;
                mockGame.exitTurnBasedMode = CyberOpsGame.prototype.exitTurnBasedMode;
                mockGame.buildTurnQueue = CyberOpsGame.prototype.buildTurnQueue;
                mockGame.startTurn = CyberOpsGame.prototype.startTurn;
                mockGame.calculateMovementRange = CyberOpsGame.prototype.calculateMovementRange;
                mockGame.isTileWalkable = () => true; // Mock function

                const wasFalse = mockGame.turnBasedMode === false;
                mockGame.toggleTurnBasedMode();
                const nowTrue = mockGame.turnBasedMode === true;
                mockGame.toggleTurnBasedMode();
                const backFalse = mockGame.turnBasedMode === false;

                results.innerHTML = `
                    <div class="${wasFalse ? 'pass' : 'fail'}">
                        ${wasFalse ? '✓' : '✗'} Started as false
                    </div>
                    <div class="${nowTrue ? 'pass' : 'fail'}">
                        ${nowTrue ? '✓' : '✗'} Toggled to true
                    </div>
                    <div class="${backFalse ? 'pass' : 'fail'}">
                        ${backFalse ? '✓' : '✗'} Toggled back to false
                    </div>
                `;
            } catch (e) {
                results.innerHTML = `<div class="fail">Error: ${e.message}</div>`;
            }
        }

        function testAP() {
            const results = document.getElementById('ap-test');
            try {
                const agentAP = mockGame.apConfig.agent;
                const guardAP = mockGame.apConfig.guard;
                const moveCost = mockGame.actionCosts.move;
                const shootCost = mockGame.actionCosts.shoot;

                results.innerHTML = `
                    <div class="${agentAP === 12 ? 'pass' : 'fail'}">
                        ${agentAP === 12 ? '✓' : '✗'} Agent AP: ${agentAP} (expected 12)
                    </div>
                    <div class="${guardAP === 8 ? 'pass' : 'fail'}">
                        ${guardAP === 8 ? '✓' : '✗'} Guard AP: ${guardAP} (expected 8)
                    </div>
                    <div class="${moveCost === 1 ? 'pass' : 'fail'}">
                        ${moveCost === 1 ? '✓' : '✗'} Move cost: ${moveCost} (expected 1)
                    </div>
                    <div class="${shootCost === 4 ? 'pass' : 'fail'}">
                        ${shootCost === 4 ? '✓' : '✗'} Shoot cost: ${shootCost} (expected 4)
                    </div>
                `;
            } catch (e) {
                results.innerHTML = `<div class="fail">Error: ${e.message}</div>`;
            }
        }

        function testGrid() {
            const results = document.getElementById('grid-test');
            try {
                mockGame.toggleGridSnap = CyberOpsGame.prototype.toggleGridSnap;

                const wasTrue = mockGame.gridSnapMovement === true;
                mockGame.toggleGridSnap();
                const nowFalse = mockGame.gridSnapMovement === false;
                mockGame.toggleGridSnap();
                const backTrue = mockGame.gridSnapMovement === true;

                results.innerHTML = `
                    <div class="${wasTrue ? 'pass' : 'fail'}">
                        ${wasTrue ? '✓' : '✗'} Started as true (default)
                    </div>
                    <div class="${nowFalse ? 'pass' : 'fail'}">
                        ${nowFalse ? '✓' : '✗'} Toggled to false
                    </div>
                    <div class="${backTrue ? 'pass' : 'fail'}">
                        ${backTrue ? '✓' : '✗'} Toggled back to true
                    </div>
                `;
            } catch (e) {
                results.innerHTML = `<div class="fail">Error: ${e.message}</div>`;
            }
        }
    </script>
</body>
</html>